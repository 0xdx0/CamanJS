<!DOCTYPE html>

<html>
<head>
  <title>caman.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="analyze.html">
                analyze.coffee
              </a>
            
              
              <a class="source" href="autoload.html">
                autoload.coffee
              </a>
            
              
              <a class="source" href="blender.html">
                blender.coffee
              </a>
            
              
              <a class="source" href="calculate.html">
                calculate.coffee
              </a>
            
              
              <a class="source" href="caman.html">
                caman.coffee
              </a>
            
              
              <a class="source" href="convert.html">
                convert.coffee
              </a>
            
              
              <a class="source" href="event.html">
                event.coffee
              </a>
            
              
              <a class="source" href="filter.html">
                filter.coffee
              </a>
            
              
              <a class="source" href="io.html">
                io.coffee
              </a>
            
              
              <a class="source" href="layer.html">
                layer.coffee
              </a>
            
              
              <a class="source" href="logger.html">
                logger.coffee
              </a>
            
              
              <a class="source" href="pixelinfo.html">
                pixelinfo.coffee
              </a>
            
              
              <a class="source" href="plugin.html">
                plugin.coffee
              </a>
            
              
              <a class="source" href="renderer.html">
                renderer.coffee
              </a>
            
              
              <a class="source" href="store.html">
                store.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="blenders.html">
                blenders.coffee
              </a>
            
              
              <a class="source" href="filters.html">
                filters.coffee
              </a>
            
              
              <a class="source" href="size.html">
                size.coffee
              </a>
            
              
              <a class="source" href="blur.html">
                blur.coffee
              </a>
            
              
              <a class="source" href="camera.html">
                camera.coffee
              </a>
            
              
              <a class="source" href="compoundBlur.html">
                compoundBlur.coffee
              </a>
            
              
              <a class="source" href="edges.html">
                edges.coffee
              </a>
            
              
              <a class="source" href="posterize.html">
                posterize.coffee
              </a>
            
              
              <a class="source" href="presets.html">
                presets.coffee
              </a>
            
              
              <a class="source" href="rotate.html">
                rotate.coffee
              </a>
            
              
              <a class="source" href="stackBlur.html">
                stackBlur.coffee
              </a>
            
              
              <a class="source" href="threshold.html">
                threshold.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>caman.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>NodeJS compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> exports?
  Root = exports
  Canvas = require <span class="string">'canvas'</span>
  Image = Canvas.Image

  Fiber = require <span class="string">'fibers'</span>

  fs = require <span class="string">'fs'</span>
<span class="keyword">else</span>
  Root = window</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>*</h2>
<p>Here it begins. Caman is defined.
There are many different initialization for Caman, which are described on the 
<a href="http://camanjs.com/guides">Basic Usage</a> page.</p>
<p>Initialization is tricky because we need to make sure everything we need is actually fully 
loaded in the DOM before proceeding. When initialized on an image, we need to make sure that the 
image is done loading before converting it to a canvas element and writing the pixel data. If we 
do this prematurely, the browser will throw a DOM Error, and chaos will ensue. In the event that 
we initialize Caman on a canvas element while specifying an image URL, we need to create a new 
image element, load the image, then continue with initialization.</p>
<p>The main goal for Caman was simplicity, so all of this is handled transparently to the end-user. </p>
<p>@class Caman
@constructor</p>
<h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>Root.Caman = <span class="class"><span class="keyword">class</span> <span class="title">Caman</span></span>
  <span class="property">@version</span>:
    release: <span class="string">"4.1.1"</span>
    date: <span class="string">"4/8/2013"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Debug mode enables console logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@DEBUG</span>: <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Are we in a NodeJS environment?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@NodeJS</span>: exports?</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Should we check the DOM for images with Caman instructions?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@autoload</span>: <span class="keyword">not</span> Caman.NodeJS</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Allow reverting the canvas?
If your JS process is running out of memory, disabling
this could help drastically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@allowRevert</span>: <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Default cross-origin policy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@crossOrigin</span>: <span class="string">"anonymous"</span>

  <span class="property">@toString</span>: -&gt;
    <span class="string">"Version "</span> + Caman.version.release + <span class="string">", Released "</span> + Caman.version.date;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Set the URL of the image proxy script</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@remoteProxy</span>: <span class="string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Change the GET param used with the proxy script if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@proxyParam</span>: <span class="string">"camanProxyUrl"</span>

  <span class="property">@getAttrId</span>: (canvas) -&gt;
    <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">if</span> Caman.NodeJS

    <span class="keyword">if</span> <span class="keyword">typeof</span> canvas <span class="keyword">is</span> <span class="string">"string"</span>
      canvas = $(canvas)

    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> canvas? <span class="keyword">and</span> canvas.getAttribute?
    canvas.getAttribute <span class="string">'data-caman-id'</span>

  constructor: -&gt;
    <span class="keyword">throw</span> <span class="string">"Invalid arguments"</span> <span class="keyword">if</span> arguments.length <span class="keyword">is</span> <span class="number">0</span>

    <span class="keyword">if</span> @ <span class="keyword">instanceof</span> Caman</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>We have to do this to avoid polluting the global scope
because of how Coffeescript binds functions specified 
with =&gt; and the fact that Caman can be invoked as both
a function and as a &#39;new&#39; object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@finishInit</span> = <span class="property">@finishInit</span>.bind(@)
      <span class="property">@imageLoaded</span> = <span class="property">@imageLoaded</span>.bind(@)

      args = arguments[<span class="number">0</span>]

      <span class="keyword">unless</span> Caman.NodeJS
        id = parseInt Caman.getAttrId(args[<span class="number">0</span>]), <span class="number">10</span>
        callback = <span class="keyword">if</span> <span class="keyword">typeof</span> args[<span class="number">1</span>] <span class="keyword">is</span> <span class="string">"function"</span>
          args[<span class="number">1</span>]
        <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">typeof</span> args[<span class="number">2</span>] <span class="keyword">is</span> <span class="string">"function"</span>
          args[<span class="number">2</span>]
        <span class="keyword">else</span>
          -&gt;

        <span class="keyword">if</span> !isNaN(id) <span class="keyword">and</span> Store.has(id)
          <span class="keyword">return</span> Store.execute(id, callback)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Every instance gets a unique ID. Makes it much simpler to check if two variables are the 
same instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@id</span> = Util.uniqid.get()
      
      <span class="property">@initializedPixelData</span> = <span class="property">@originalPixelData</span> = <span class="literal">null</span>
      <span class="property">@cropCoordinates</span> = x: <span class="number">0</span>, y: <span class="number">0</span>
      <span class="property">@cropped</span> = <span class="literal">false</span>
      <span class="property">@resized</span> = <span class="literal">false</span>

      <span class="property">@pixelStack</span> = []  <span class="comment"># Stores the pixel layers</span>
      <span class="property">@layerStack</span> = []  <span class="comment"># Stores all of the layers waiting to be rendered</span>
      <span class="property">@canvasQueue</span> = [] <span class="comment"># Stores all of the canvases to be processed</span>
      <span class="property">@currentLayer</span> = <span class="literal">null</span>
      <span class="property">@scaled</span> = <span class="literal">false</span>

      <span class="property">@analyze</span> = <span class="keyword">new</span> Analyze @
      <span class="property">@renderer</span> = <span class="keyword">new</span> Renderer @

      <span class="property">@domIsLoaded</span> =&gt;  
        <span class="property">@parseArguments</span>(args)
        <span class="property">@setup</span>()

      <span class="keyword">return</span> @
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="keyword">new</span> Caman(arguments)

  domIsLoaded: (cb) -&gt;
    <span class="keyword">if</span> Caman.NodeJS
      setTimeout =&gt;
        cb.call(@)
      , <span class="number">0</span>
    <span class="keyword">else</span>
      <span class="keyword">if</span> document.readyState <span class="keyword">is</span> <span class="string">"complete"</span>
        Log.debug <span class="string">"DOM initialized"</span>
        setTimeout =&gt;
          cb.call(@)
        , <span class="number">0</span>
      <span class="keyword">else</span>
        <span class="function"><span class="title">listener</span></span> = =&gt;
          <span class="keyword">if</span> document.readyState <span class="keyword">is</span> <span class="string">"complete"</span>
            Log.debug <span class="string">"DOM initialized"</span>
            cb.call(@)

        document.addEventListener <span class="string">"readystatechange"</span>, listener, <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>All possible combinations:</p>
<p><strong>1 argument</strong>
  - Image selector
  - Image object
  - Canvas selector
  - Canvas object</p>
<p><strong>2 arguments</strong>
  - Image selector + callback
  - Image object + callback
  - Canvas selector + URL
  - Canvas object + URL</p>
<p><strong>3 arguments</strong>
  - Canvas selector + URL + callback
  - Canvas object + URL + callback</p>
<p><strong>NodeJS</strong>
  - file path
  - file object
  - file path + callback
  - file object + callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parseArguments: (args) -&gt;
    <span class="keyword">throw</span> <span class="string">"Invalid arguments given"</span> <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@initObj</span> = <span class="literal">null</span>
    <span class="property">@initType</span> = <span class="literal">null</span>
    <span class="property">@imageUrl</span> = <span class="literal">null</span>
    <span class="property">@callback</span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>First argument is always our canvas/image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@setInitObject</span> args[<span class="number">0</span>]
    <span class="keyword">return</span> <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">1</span>
    
    <span class="keyword">switch</span> <span class="keyword">typeof</span> args[<span class="number">1</span>]
      <span class="keyword">when</span> <span class="string">"string"</span> <span class="keyword">then</span> <span class="property">@imageUrl</span> = args[<span class="number">1</span>]
      <span class="keyword">when</span> <span class="string">"function"</span> <span class="keyword">then</span> <span class="property">@callback</span> = args[<span class="number">1</span>]
      
    <span class="keyword">return</span> <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">2</span>

    <span class="property">@callback</span> = args[<span class="number">2</span>]

    <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">4</span>
      <span class="property">@options</span>[key] = val <span class="keyword">for</span> own key, val <span class="keyword">of</span> args[<span class="number">4</span>]

  setInitObject: (obj) -&gt;
    <span class="keyword">if</span> Caman.NodeJS
      <span class="property">@initObj</span> = obj
      <span class="property">@initType</span> = <span class="string">'node'</span>
      <span class="keyword">return</span>

    <span class="keyword">if</span> <span class="keyword">typeof</span> obj <span class="keyword">is</span> <span class="string">"object"</span>
      <span class="property">@initObj</span> = obj
    <span class="keyword">else</span>
      <span class="property">@initObj</span> = $(obj)

    <span class="keyword">throw</span> <span class="string">"Could not find image or canvas for initialization."</span> <span class="keyword">unless</span> <span class="property">@initObj</span>?

    <span class="property">@initType</span> = <span class="property">@initObj</span>.nodeName.toLowerCase()

  setup: -&gt;
    <span class="keyword">switch</span> <span class="property">@initType</span>
      <span class="keyword">when</span> <span class="string">"node"</span> <span class="keyword">then</span> <span class="property">@initNode</span>()
      <span class="keyword">when</span> <span class="string">"img"</span> <span class="keyword">then</span> <span class="property">@initImage</span>()
      <span class="keyword">when</span> <span class="string">"canvas"</span> <span class="keyword">then</span> <span class="property">@initCanvas</span>()

  initNode: -&gt;
    Log.debug <span class="string">"Initializing for NodeJS"</span>

    <span class="property">@image</span> = <span class="keyword">new</span> Image()
    <span class="property">@image</span>.<span class="function"><span class="title">onload</span></span> = =&gt;
      Log.debug <span class="string">"Image loaded. Width = <span class="subst">#{@imageWidth()}</span>, Height = <span class="subst">#{@imageHeight()}</span>"</span>
      <span class="property">@canvas</span> = <span class="keyword">new</span> Canvas <span class="property">@imageWidth</span>(), <span class="property">@imageHeight</span>()
      <span class="property">@finishInit</span>()

    <span class="property">@image</span>.<span class="function"><span class="title">onerror</span></span> = (err) -&gt; <span class="keyword">throw</span> err
    <span class="property">@image</span>.src = <span class="property">@initObj</span>

  initImage: -&gt;
    <span class="property">@image</span> = <span class="property">@initObj</span>
    <span class="property">@canvas</span> = document.createElement <span class="string">'canvas'</span>
    <span class="property">@context</span> = <span class="property">@canvas</span>.getContext <span class="string">'2d'</span>
    Util.copyAttributes <span class="property">@image</span>, <span class="property">@canvas</span>, except: [<span class="string">'src'</span>]

    <span class="property">@image</span>.parentNode.replaceChild <span class="property">@canvas</span>, <span class="property">@image</span>

    <span class="property">@imageAdjustments</span>()
    <span class="property">@waitForImageLoaded</span>()

  initCanvas: -&gt;
    <span class="property">@canvas</span> = <span class="property">@initObj</span>
    <span class="property">@context</span> = <span class="property">@canvas</span>.getContext <span class="string">'2d'</span>

    <span class="keyword">if</span> <span class="property">@imageUrl</span>?
      <span class="property">@image</span> = document.createElement <span class="string">'img'</span>
      <span class="property">@image</span>.src = <span class="property">@imageUrl</span>

      <span class="property">@imageAdjustments</span>()
      <span class="property">@waitForImageLoaded</span>()
    <span class="keyword">else</span>
      <span class="property">@finishInit</span>()

  imageAdjustments: -&gt;
    <span class="keyword">if</span> <span class="property">@needsHiDPISwap</span>()
      Log.debug <span class="property">@image</span>.src, <span class="string">"-&gt;"</span>, <span class="property">@hiDPIReplacement</span>()

      <span class="property">@swapped</span> = <span class="literal">true</span>
      <span class="property">@image</span>.src = <span class="property">@hiDPIReplacement</span>()

    <span class="keyword">if</span> IO.isRemote(<span class="property">@image</span>)
      <span class="property">@image</span>.src = IO.proxyUrl(<span class="property">@image</span>.src)
      Log.debug <span class="string">"Remote image detected, using URL = <span class="subst">#{@image.src}</span>"</span>

  waitForImageLoaded: -&gt;
    <span class="keyword">if</span> <span class="property">@isImageLoaded</span>()
      <span class="property">@imageLoaded</span>()
    <span class="keyword">else</span>
      <span class="property">@image</span>.onload = <span class="property">@imageLoaded</span>

  isImageLoaded: -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> <span class="property">@image</span>.complete
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="property">@image</span>.naturalWidth? <span class="keyword">and</span> <span class="property">@image</span>.naturalWidth <span class="keyword">is</span> <span class="number">0</span>
    <span class="keyword">return</span> <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Internet Explorer has issues figuring out image dimensions when they aren&#39;t
explicitly defined apparently. We check the normal width/height properties first,
but fall back to natural sizes if they are 0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  imageWidth: -&gt; <span class="property">@image</span>.width <span class="keyword">or</span> <span class="property">@image</span>.naturalWidth
  imageHeight: -&gt; <span class="property">@image</span>.height <span class="keyword">or</span> <span class="property">@image</span>.naturalHeight

  imageLoaded: -&gt;
    Log.debug <span class="string">"Image loaded. Width = <span class="subst">#{@imageWidth()}</span>, Height = <span class="subst">#{@imageHeight()}</span>"</span>

    <span class="keyword">if</span> <span class="property">@swapped</span>
      <span class="property">@canvas</span>.width = <span class="property">@imageWidth</span>() / <span class="property">@hiDPIRatio</span>()
      <span class="property">@canvas</span>.height = <span class="property">@imageHeight</span>() / <span class="property">@hiDPIRatio</span>()
    <span class="keyword">else</span>
      <span class="property">@canvas</span>.width = <span class="property">@imageWidth</span>()
      <span class="property">@canvas</span>.height = <span class="property">@imageHeight</span>()

    <span class="property">@finishInit</span>()

  finishInit: -&gt;
    <span class="property">@context</span> = <span class="property">@canvas</span>.getContext <span class="string">'2d'</span> <span class="keyword">unless</span> <span class="property">@context</span>?

    <span class="property">@originalWidth</span> = <span class="property">@preScaledWidth</span> = <span class="property">@width</span> = <span class="property">@canvas</span>.width
    <span class="property">@originalHeight</span> = <span class="property">@preScaledHeight</span> = <span class="property">@height</span> = <span class="property">@canvas</span>.height

    <span class="property">@hiDPIAdjustments</span>()
    <span class="property">@assignId</span>() <span class="keyword">unless</span> <span class="property">@hasId</span>()

    <span class="keyword">if</span> <span class="property">@image</span>?
      <span class="property">@context</span>.drawImage <span class="property">@image</span>, 
        <span class="number">0</span>, <span class="number">0</span>, 
        <span class="property">@imageWidth</span>(), <span class="property">@imageHeight</span>(), 
        <span class="number">0</span>, <span class="number">0</span>, 
        <span class="property">@preScaledWidth</span>, <span class="property">@preScaledHeight</span>
    
    <span class="property">@imageData</span> = <span class="property">@context</span>.getImageData <span class="number">0</span>, <span class="number">0</span>, <span class="property">@canvas</span>.width, <span class="property">@canvas</span>.height
    <span class="property">@pixelData</span> = <span class="property">@imageData</span>.data
    
    <span class="keyword">if</span> Caman.allowRevert
      <span class="property">@initializedPixelData</span> = Util.dataArray(<span class="property">@pixelData</span>.length)
      <span class="property">@originalPixelData</span> = Util.dataArray(<span class="property">@pixelData</span>.length)

      <span class="keyword">for</span> pixel, i <span class="keyword">in</span> <span class="property">@pixelData</span>
        <span class="property">@initializedPixelData</span>[i] = pixel
        <span class="property">@originalPixelData</span>[i] = pixel

    <span class="property">@dimensions</span> =
      width: <span class="property">@canvas</span>.width
      height: <span class="property">@canvas</span>.height

    Store.put <span class="property">@id</span>, @

    <span class="property">@callback</span>.call @,@</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Reset the callback so re-initialization doesn&#39;t
trigger it again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@callback</span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If you have a separate context reference to this canvas outside of CamanJS
and you make a change to the canvas outside of CamanJS, you will have to call
this function to update our context reference to include those changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reloadCanvasData: -&gt;
    <span class="property">@imageData</span> = <span class="property">@context</span>.getImageData <span class="number">0</span>, <span class="number">0</span>, <span class="property">@canvas</span>.width, <span class="property">@canvas</span>.height
    <span class="property">@pixelData</span> = <span class="property">@imageData</span>.data

  resetOriginalPixelData: -&gt;
    <span class="keyword">throw</span> <span class="string">"Revert disabled"</span> <span class="keyword">unless</span> Caman.allowRevert

    <span class="property">@originalPixelData</span> = Util.dataArray(<span class="property">@pixelData</span>.length)
    <span class="property">@originalPixelData</span>[i] = pixel <span class="keyword">for</span> pixel, i <span class="keyword">in</span> <span class="property">@pixelData</span>

  hasId: -&gt; Caman.getAttrId(<span class="property">@canvas</span>)?

  assignId: -&gt;
    <span class="keyword">return</span> <span class="keyword">if</span> Caman.NodeJS <span class="keyword">or</span> <span class="property">@canvas</span>.getAttribute <span class="string">'data-caman-id'</span>
    <span class="property">@canvas</span>.setAttribute <span class="string">'data-caman-id'</span>, <span class="property">@id</span>

  hiDPIDisabled: -&gt;
    <span class="property">@canvas</span>.getAttribute(<span class="string">'data-caman-hidpi-disabled'</span>) <span class="keyword">isnt</span> <span class="literal">null</span>

  hiDPIAdjustments: -&gt;
    <span class="keyword">return</span> <span class="keyword">if</span> Caman.NodeJS <span class="keyword">or</span> !<span class="property">@needsHiDPISwap</span>()

    ratio = <span class="property">@hiDPIRatio</span>()

    <span class="keyword">if</span> ratio <span class="keyword">isnt</span> <span class="number">1</span>
      Log.debug <span class="string">"HiDPI ratio = <span class="subst">#{ratio}</span>"</span>
      <span class="property">@scaled</span> = <span class="literal">true</span>

      <span class="property">@preScaledWidth</span> = <span class="property">@canvas</span>.width
      <span class="property">@preScaledHeight</span> = <span class="property">@canvas</span>.height

      <span class="property">@canvas</span>.width = <span class="property">@preScaledWidth</span> * ratio
      <span class="property">@canvas</span>.height = <span class="property">@preScaledHeight</span> * ratio
      <span class="property">@canvas</span>.style.width = <span class="string">"<span class="subst">#{@preScaledWidth}</span>px"</span>
      <span class="property">@canvas</span>.style.height = <span class="string">"<span class="subst">#{@preScaledHeight}</span>px"</span>

      <span class="property">@context</span>.scale ratio, ratio

      <span class="property">@width</span> = <span class="property">@originalWidth</span> = <span class="property">@canvas</span>.width
      <span class="property">@height</span> = <span class="property">@originalHeight</span> = <span class="property">@canvas</span>.height

  hiDPIRatio: -&gt;
    devicePixelRatio = window.devicePixelRatio <span class="keyword">or</span> <span class="number">1</span>
    backingStoreRatio = <span class="property">@context</span>.webkitBackingStorePixelRatio <span class="keyword">or</span>
                        <span class="property">@context</span>.mozBackingStorePixelRatio <span class="keyword">or</span>
                        <span class="property">@context</span>.msBackingStorePixelRatio <span class="keyword">or</span>
                        <span class="property">@context</span>.oBackingStorePixelRatio <span class="keyword">or</span>
                        <span class="property">@context</span>.backingStorePixelRatio <span class="keyword">or</span> <span class="number">1</span>

    devicePixelRatio / backingStoreRatio

  hiDPICapable: -&gt; window.devicePixelRatio? <span class="keyword">and</span> window.devicePixelRatio <span class="keyword">isnt</span> <span class="number">1</span>

  needsHiDPISwap: -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="property">@hiDPIDisabled</span>() <span class="keyword">or</span> !<span class="property">@hiDPICapable</span>()
    <span class="property">@hiDPIReplacement</span>() <span class="keyword">isnt</span> <span class="literal">null</span>

  hiDPIReplacement: -&gt;
    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> <span class="property">@image</span>?
    <span class="property">@image</span>.getAttribute <span class="string">'data-caman-hidpi'</span>

  replaceCanvas: (newCanvas) -&gt;
    oldCanvas = <span class="property">@canvas</span>
    <span class="property">@canvas</span> = newCanvas
    <span class="property">@context</span> = <span class="property">@canvas</span>.getContext <span class="string">'2d'</span>

    oldCanvas.parentNode.replaceChild <span class="property">@canvas</span>, oldCanvas

    <span class="property">@width</span>  = <span class="property">@canvas</span>.width
    <span class="property">@height</span> = <span class="property">@canvas</span>.height

    <span class="property">@reloadCanvasData</span>()

    <span class="property">@dimensions</span> =
      width: <span class="property">@canvas</span>.width
      height: <span class="property">@canvas</span>.height</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Begins the rendering process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: (<span class="function"><span class="title">callback</span></span> = -&gt;) -&gt;
    Event.trigger @, <span class="string">"renderStart"</span>
    
    <span class="property">@renderer</span>.execute =&gt;
      <span class="property">@context</span>.putImageData <span class="property">@imageData</span>, <span class="number">0</span>, <span class="number">0</span>
      callback.call @</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Reverts the canvas back to it&#39;s original state while
maintaining any cropped or resized dimensions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  revert: -&gt;
    <span class="keyword">throw</span> <span class="string">"Revert disabled"</span> <span class="keyword">unless</span> Caman.allowRevert

    <span class="property">@pixelData</span>[i] = pixel <span class="keyword">for</span> pixel, i <span class="keyword">in</span> <span class="property">@originalVisiblePixels</span>()
    <span class="property">@context</span>.putImageData <span class="property">@imageData</span>, <span class="number">0</span>, <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Completely resets the canvas back to it&#39;s original state.
Any size adjustments will also be reset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: -&gt;
    canvas = document.createElement(<span class="string">'canvas'</span>)
    Util.copyAttributes(<span class="property">@canvas</span>, canvas)

    canvas.width = <span class="property">@originalWidth</span>
    canvas.height = <span class="property">@originalHeight</span>

    ctx = canvas.getContext(<span class="string">'2d'</span>)
    imageData = ctx.getImageData <span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height
    pixelData = imageData.data

    pixelData[i] = pixel <span class="keyword">for</span> pixel, i <span class="keyword">in</span> <span class="property">@initializedPixelData</span>

    ctx.putImageData imageData, <span class="number">0</span>, <span class="number">0</span>

    <span class="property">@cropCoordinates</span> = x: <span class="number">0</span>, y: <span class="number">0</span>
    <span class="property">@resized</span> = <span class="literal">false</span>

    <span class="property">@replaceCanvas</span>(canvas)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Returns the original pixel data while maintaining any
cropping or resizing that may have occured.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  originalVisiblePixels: -&gt;
    <span class="keyword">throw</span> <span class="string">"Revert disabled"</span> <span class="keyword">unless</span> Caman.allowRevert

    pixels = []

    startX = <span class="property">@cropCoordinates</span>.x
    endX = startX + <span class="property">@width</span>
    startY = <span class="property">@cropCoordinates</span>.y
    endY = startY + <span class="property">@height</span>

    <span class="keyword">if</span> <span class="property">@resized</span>
      canvas = document.createElement(<span class="string">'canvas'</span>)
      canvas.width = <span class="property">@originalWidth</span>
      canvas.height = <span class="property">@originalHeight</span>

      ctx = canvas.getContext(<span class="string">'2d'</span>)
      imageData = ctx.getImageData <span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height
      pixelData = imageData.data

      pixelData[i] = pixel <span class="keyword">for</span> pixel, i <span class="keyword">in</span> <span class="property">@originalPixelData</span>

      ctx.putImageData imageData, <span class="number">0</span>, <span class="number">0</span>

      scaledCanvas = document.createElement(<span class="string">'canvas'</span>)
      scaledCanvas.width = <span class="property">@width</span>
      scaledCanvas.height = <span class="property">@height</span>

      ctx = scaledCanvas.getContext(<span class="string">'2d'</span>)
      ctx.drawImage canvas, <span class="number">0</span>, <span class="number">0</span>, <span class="property">@originalWidth</span>, <span class="property">@originalHeight</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="property">@width</span>, <span class="property">@height</span>

      pixelData = ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="property">@width</span>, <span class="property">@height</span>).data
      width = <span class="property">@width</span>
    <span class="keyword">else</span>
      pixelData = <span class="property">@originalPixelData</span>
      width = <span class="property">@originalWidth</span>

    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..pixelData.length] <span class="keyword">by</span> <span class="number">4</span>
      coord = PixelInfo.locationToCoordinates(i, width)
      <span class="keyword">if</span> (startX &lt;= coord.x &lt; endX) <span class="keyword">and</span> (startY &lt;= coord.y &lt; endY)
        pixels.push pixelData[i], 
          pixelData[i+<span class="number">1</span>],
          pixelData[i+<span class="number">2</span>], 
          pixelData[i+<span class="number">3</span>]

    pixels</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Pushes the filter callback that modifies the RGBA object into the
render queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  process: (name, processFn) -&gt;
    <span class="property">@renderer</span>.add
      type: Filter.Type.Single
      name: name
      processFn: processFn

    <span class="keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Pushes the kernel into the render queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  processKernel: (name, adjust, divisor, bias) -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> divisor
      divisor = <span class="number">0</span>
      divisor += adjust[i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..adjust.length]

    <span class="property">@renderer</span>.add
      type: Filter.Type.Kernel
      name: name
      adjust: adjust
      divisor: divisor
      bias: bias <span class="keyword">or</span> <span class="number">0</span>

    <span class="keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Adds a standalone plugin into the render queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  processPlugin: (plugin, args) -&gt;
    <span class="property">@renderer</span>.add
      type: Filter.Type.Plugin
      plugin: plugin
      args: args

    <span class="keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Pushes a new layer operation into the render queue and calls the layer
callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  newLayer: (callback) -&gt;
    layer = <span class="keyword">new</span> Layer @
    <span class="property">@canvasQueue</span>.push layer
    <span class="property">@renderer</span>.add type: Filter.Type.LayerDequeue

    callback.call layer

    <span class="property">@renderer</span>.add type: Filter.Type.LayerFinished
    <span class="keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Pushes the layer context and moves to the next operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  executeLayer: (layer) -&gt; <span class="property">@pushContext</span> layer</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Set all of the relevant data to the new layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pushContext: (layer) -&gt;
    <span class="property">@layerStack</span>.push <span class="property">@currentLayer</span>
    <span class="property">@pixelStack</span>.push <span class="property">@pixelData</span>
    <span class="property">@currentLayer</span> = layer
    <span class="property">@pixelData</span> = layer.pixelData</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Restore the previous layer context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  popContext: -&gt;
    <span class="property">@pixelData</span> = <span class="property">@pixelStack</span>.pop()
    <span class="property">@currentLayer</span> = <span class="property">@layerStack</span>.pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Applies the current layer to its parent layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  applyCurrentLayer: -&gt; <span class="property">@currentLayer</span>.applyToParent()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
